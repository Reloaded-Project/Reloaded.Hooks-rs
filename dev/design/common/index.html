
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://github.com/Reloaded-Project/Reloaded.Hooks-rs/dev/design/common/">
      
      
        <link rel="prev" href="../../..">
      
      
        <link rel="next" href="../wrappers/">
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.0.6">
    
    
      
        <title>Common Notes - Reloaded Hooks NexGen</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.558e4712.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.2505c338.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../Reloaded/Stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="reloaded3-slate" data-md-color-primary="" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#common-design-notes" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Reloaded Hooks NexGen" class="md-header__button md-logo" aria-label="Reloaded Hooks NexGen" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Reloaded Hooks NexGen
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Common Notes
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/Reloaded-Project/Reloaded.Hooks-rs" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    Reloaded-Project/Reloaded.Hooks-rs
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Reloaded Hooks NexGen" class="md-nav__button md-logo" aria-label="Reloaded Hooks NexGen" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Reloaded Hooks NexGen
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/Reloaded-Project/Reloaded.Hooks-rs" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    Reloaded-Project/Reloaded.Hooks-rs
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      
      
        <label class="md-nav__link" for="__nav_2" tabindex="0" aria-expanded="true">
          Library Internals
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Library Internals" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Library Internals
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " data-md-toggle="__nav_2_1" type="checkbox" id="__nav_2_1" checked>
      
      
      
        <label class="md-nav__link" for="__nav_2_1" tabindex="0" aria-expanded="true">
          Design Docs
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Design Docs" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_1">
          <span class="md-nav__icon md-icon"></span>
          Design Docs
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Common Notes
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Common Notes
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#wrappers" class="md-nav__link">
    Wrappers
  </a>
  
    <nav class="md-nav" aria-label="Wrappers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#wrapper" class="md-nav__link">
    Wrapper
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reversewrapper" class="md-nav__link">
    ReverseWrapper
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hook-memory-layouts-thread-safety" class="md-nav__link">
    Hook Memory Layouts &amp; Thread Safety
  </a>
  
    <nav class="md-nav" aria-label="Hook Memory Layouts &amp; Thread Safety">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#stub-layout" class="md-nav__link">
    Stub Layout
  </a>
  
    <nav class="md-nav" aria-label="Stub Layout">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example" class="md-nav__link">
    Example
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#heap-props-layout" class="md-nav__link">
    Heap (Props) Layout
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-enable-disable-process" class="md-nav__link">
    The 'Enable' / 'Disable' Process
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#limits" class="md-nav__link">
    Limits
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#thread-safety-on-x86" class="md-nav__link">
    Thread Safety on x86
  </a>
  
    <nav class="md-nav" aria-label="Thread Safety on x86">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-theory" class="md-nav__link">
    The Theory
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#what-happens-in-practice" class="md-nav__link">
    What Happens in Practice
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#what-is-safe" class="md-nav__link">
    What is Safe
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hook-length-mismatch-problem" class="md-nav__link">
    Hook Length Mismatch Problem
  </a>
  
    <nav class="md-nav" aria-label="Hook Length Mismatch Problem">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#when-your-hook-is-shorter-than-original" class="md-nav__link">
    When your hook is shorter than original.
  </a>
  
    <nav class="md-nav" aria-label="When your hook is shorter than original.">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#resolution-strategy" class="md-nav__link">
    Resolution Strategy
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#when-your-hook-is-longer-than-original" class="md-nav__link">
    When your hook is longer than original.
  </a>
  
    <nav class="md-nav" aria-label="When your hook is longer than original.">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#resolution-strategy_1" class="md-nav__link">
    Resolution Strategy
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fallback-strategies" class="md-nav__link">
    Fallback Strategies
  </a>
  
    <nav class="md-nav" aria-label="Fallback Strategies">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#return-address-patching" class="md-nav__link">
    Return Address Patching
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#requirements-for-external-libraries-to-interoperate" class="md-nav__link">
    Requirements for External Libraries to Interoperate
  </a>
  
    <nav class="md-nav" aria-label="Requirements for External Libraries to Interoperate">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#hooking-over-reloaded-hooks" class="md-nav__link">
    Hooking Over Reloaded Hooks
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reloaded-hooks-hooking-over-existing-hooks" class="md-nav__link">
    Reloaded Hooks hooking over Existing Hooks
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../wrappers/" class="md-nav__link">
        Wrapper Generation
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " data-md-toggle="__nav_2_1_3" type="checkbox" id="__nav_2_1_3" >
      
      
      
        <label class="md-nav__link" for="__nav_2_1_3" tabindex="0" aria-expanded="false">
          Function Hooks
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Function Hooks" data-md-level="3">
        <label class="md-nav__title" for="__nav_2_1_3">
          <span class="md-nav__icon md-icon"></span>
          Function Hooks
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../function-hooks/overview/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " data-md-toggle="__nav_2_1_3_2" type="checkbox" id="__nav_2_1_3_2" >
      
      
      
        <label class="md-nav__link" for="__nav_2_1_3_2" tabindex="0" aria-expanded="false">
          Hooking Strategy
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Hooking Strategy" data-md-level="4">
        <label class="md-nav__title" for="__nav_2_1_3_2">
          <span class="md-nav__icon md-icon"></span>
          Hooking Strategy
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../function-hooks/hooking-strategy/" class="md-nav__link">
        General
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../function-hooks/hooking-strategy-x86/" class="md-nav__link">
        x86
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../function-hooks/hooking-strategy-arm64/" class="md-nav__link">
        ARM64
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../assembly-hooks/overview/" class="md-nav__link">
        Assembly Hooks
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../branch-hooks/overview/" class="md-nav__link">
        Branch Hooks
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../vtable-hooks/overview/" class="md-nav__link">
        VTable Hooks
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " data-md-toggle="__nav_2_2" type="checkbox" id="__nav_2_2" >
      
      
      
        <label class="md-nav__link" for="__nav_2_2" tabindex="0" aria-expanded="false">
          Architectures
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Architectures" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_2">
          <span class="md-nav__icon md-icon"></span>
          Architectures
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../arch/overview/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../arch/operations/" class="md-nav__link">
        Operations
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../arch/operations-impl/" class="md-nav__link">
        Operations (Implemented)
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " data-md-toggle="__nav_2_2_4" type="checkbox" id="__nav_2_2_4" >
      
      
      
        <label class="md-nav__link" for="__nav_2_2_4" tabindex="0" aria-expanded="false">
          x86
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="x86" data-md-level="3">
        <label class="md-nav__title" for="__nav_2_2_4">
          <span class="md-nav__icon md-icon"></span>
          x86
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../arch/x86/x86/" class="md-nav__link">
        Overview (x86)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../arch/x86/x86_64/" class="md-nav__link">
        Overview (x86_64)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../arch/x86/code_relocation/" class="md-nav__link">
        Code Relocation
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " data-md-toggle="__nav_2_2_5" type="checkbox" id="__nav_2_2_5" >
      
      
      
        <label class="md-nav__link" for="__nav_2_2_5" tabindex="0" aria-expanded="false">
          arm64
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="arm64" data-md-level="3">
        <label class="md-nav__title" for="__nav_2_2_5">
          <span class="md-nav__icon md-icon"></span>
          arm64
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../arch/arm64/aarch64/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../arch/arm64/code_relocation/" class="md-nav__link">
        Code Relocation
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../platform/overview/" class="md-nav__link">
        Platform Support
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../contributing/" class="md-nav__link">
        Contributing
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../Reloaded/Pages/license/" class="md-nav__link">
        License
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../Reloaded/Pages/contributing/" class="md-nav__link">
        How to Document
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#wrappers" class="md-nav__link">
    Wrappers
  </a>
  
    <nav class="md-nav" aria-label="Wrappers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#wrapper" class="md-nav__link">
    Wrapper
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reversewrapper" class="md-nav__link">
    ReverseWrapper
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hook-memory-layouts-thread-safety" class="md-nav__link">
    Hook Memory Layouts &amp; Thread Safety
  </a>
  
    <nav class="md-nav" aria-label="Hook Memory Layouts &amp; Thread Safety">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#stub-layout" class="md-nav__link">
    Stub Layout
  </a>
  
    <nav class="md-nav" aria-label="Stub Layout">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example" class="md-nav__link">
    Example
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#heap-props-layout" class="md-nav__link">
    Heap (Props) Layout
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-enable-disable-process" class="md-nav__link">
    The 'Enable' / 'Disable' Process
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#limits" class="md-nav__link">
    Limits
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#thread-safety-on-x86" class="md-nav__link">
    Thread Safety on x86
  </a>
  
    <nav class="md-nav" aria-label="Thread Safety on x86">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-theory" class="md-nav__link">
    The Theory
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#what-happens-in-practice" class="md-nav__link">
    What Happens in Practice
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#what-is-safe" class="md-nav__link">
    What is Safe
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hook-length-mismatch-problem" class="md-nav__link">
    Hook Length Mismatch Problem
  </a>
  
    <nav class="md-nav" aria-label="Hook Length Mismatch Problem">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#when-your-hook-is-shorter-than-original" class="md-nav__link">
    When your hook is shorter than original.
  </a>
  
    <nav class="md-nav" aria-label="When your hook is shorter than original.">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#resolution-strategy" class="md-nav__link">
    Resolution Strategy
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#when-your-hook-is-longer-than-original" class="md-nav__link">
    When your hook is longer than original.
  </a>
  
    <nav class="md-nav" aria-label="When your hook is longer than original.">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#resolution-strategy_1" class="md-nav__link">
    Resolution Strategy
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fallback-strategies" class="md-nav__link">
    Fallback Strategies
  </a>
  
    <nav class="md-nav" aria-label="Fallback Strategies">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#return-address-patching" class="md-nav__link">
    Return Address Patching
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#requirements-for-external-libraries-to-interoperate" class="md-nav__link">
    Requirements for External Libraries to Interoperate
  </a>
  
    <nav class="md-nav" aria-label="Requirements for External Libraries to Interoperate">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#hooking-over-reloaded-hooks" class="md-nav__link">
    Hooking Over Reloaded Hooks
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reloaded-hooks-hooking-over-existing-hooks" class="md-nav__link">
    Reloaded Hooks hooking over Existing Hooks
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  



<h1 id="common-design-notes">Common Design Notes</h1>
<div class="admonition info">
<p class="admonition-title">Design notes common to all hooking strategies.</p>
</div>
<h2 id="wrappers">Wrappers</h2>
<h3 id="wrapper">Wrapper</h3>
<div class="admonition info">
<p class="admonition-title">Wrappers are stubs which convert from the calling convention of the original function to your calling convention.</p>
</div>
<div class="admonition note">
<p class="admonition-title">If the calling convention of the hooked function and your function matches, this wrapper is simply just 1 <code>jmp</code> instruction.</p>
</div>
<p>Wrappers are documented <a href="../wrappers/">in their own page here</a>.</p>
<h3 id="reversewrapper">ReverseWrapper</h3>
<div class="admonition info">
<p class="admonition-title">Stub which converts from your code's calling convention to original function's calling convention</p>
</div>
<div class="admonition info">
<p class="admonition-title">This is basically <a href="#wrappers">Wrapper</a> with <code>source</code> and <code>destination</code> swapped around</p>
</div>
<h2 id="hook-memory-layouts-thread-safety">Hook Memory Layouts &amp; Thread Safety</h2>
<div class="admonition info">
<p class="admonition-title">Hooks in <code>reloaded-hooks-rs</code> are structured in a very specific way to ensure thread safety.</p>
</div>
<div class="admonition info">
<p class="admonition-title">They sacrifice a bit of memory usage in favour of performance + thread safety.</p>
</div>
<p>Most hooks, regardless of type have a memory layout that looks something like this:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Size: 2 registers</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Hook</span>
<span class="p">{</span>
<span class="w">    </span><span class="sd">/// The address of the stub containing bridging code</span>
<span class="w">    </span><span class="sd">/// between your code and custom code. This is the address</span>
<span class="w">    </span><span class="sd">/// of the code that will actually be executed at runtime.</span>
<span class="w">    </span><span class="n">stub_address</span>: <span class="kt">usize</span><span class="p">,</span>

<span class="w">    </span><span class="sd">/// Address of the &#39;properties&#39; structure, containing</span>
<span class="w">    </span><span class="sd">/// the necessary info to manipulate the data at stub_address</span>
<span class="w">    </span><span class="n">props</span>: <span class="nc">NonNull</span><span class="o">&lt;</span><span class="n">StubPackedProps</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>
<p>Notably, there are two heap allocations. One at <code>stub_address</code>, which contains the executable code,
and one at <code>props</code>, which contains packed info of the stub at <code>stub_address</code>.</p>
<p>The hooks use a 'swapping' system. Both <code>stub_address</code> and <code>props</code> contains <code>swap space</code>. When you
enable or disable a hook, the data in the two 'swap spaces' are swapped around. </p>
<p>In other words, when <code>stub_address</code>' 'swap space' contains the code for <code>HookFunction</code> (hook enabled), 
the 'swap space' at <code>props</code>' contains the code for <code>Original Code</code>.</p>
<p>Thread safety is ensured by making writes within the stub itself atomic, as well as making the emplacing
of the jump to the stub in the original application code atomic.</p>
<h3 id="stub-layout">Stub Layout</h3>
<div class="admonition info">
<p class="admonition-title">The memory region containing the actual executed code.</p>
</div>
<p>The stub has two possible layouts, if the <code>Swap Space</code> is small enough such that it can be atomically
overwritten, it will look like this:</p>
<div class="highlight"><pre><span></span><code>- &#39;Swap Space&#39; [HookCode / OriginalCode]
&lt;pad to atomic register size&gt;
</code></pre></div>
<p>Otherwise, if <code>Swap Space</code> cannot be atomically overwritten, it will look like:</p>
<div class="highlight"><pre><span></span><code>- &#39;Swap Space&#39; [HookCode / OriginalCode]
- HookCode
- OriginalCode
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Some hooks may store, extra data after <code>OriginalCode</code>.</p>
</div>
<p>For example, if calling convention conversion is needed, the <code>HookCode</code> becomes a 
<a href="#reversewrapper">ReverseWrapper</a>, and the stub will also contain a <a href="#wrapper">Wrapper</a>.</p>
<p>If calling convention conversion is needed, the layout looks like this:</p>
<div class="highlight"><pre><span></span><code>- &#39;Swap Space&#39; [ReverseWrapper / OriginalCode]
- ReverseWrapper
- OriginalCode
- Wrapper
</code></pre></div>
<h4 id="example">Example</h4>
<div class="admonition info">
<p class="admonition-title">Using ARM64 <a href="../assembly-hooks/overview/">Assembly Hook</a> as an example.</p>
</div>
<p>If the <em>'OriginalCode'</em> was:</p>
<div class="highlight"><pre><span></span><code><span class="nf">mov</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span>
<span class="nf">add</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x2</span>
</code></pre></div>
<p>And the <em>'HookCode'</em> was:</p>
<div class="highlight"><pre><span></span><code><span class="nf">add</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span>
<span class="nf">mov</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x2</span>
</code></pre></div>
<p>The memory would look like this when hook is enabled.</p>
<div class="highlight"><pre><span></span><code><span class="nl">swap:</span><span class="w"> </span><span class="c1">; Currently Applied (Hook)</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span>
<span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x2</span>
<span class="w">    </span><span class="nf">b</span><span class="w"> </span><span class="no">back_to_code</span>

<span class="nl">hook:</span><span class="w"> </span><span class="c1">; HookCode</span>
<span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x2</span>
<span class="w">    </span><span class="nf">b</span><span class="w"> </span><span class="no">back_to_code</span>

<span class="nl">original:</span><span class="w"> </span><span class="c1">; OriginalCode</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span>
<span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x2</span>
<span class="w">    </span><span class="nf">b</span><span class="w"> </span><span class="no">back_to_code</span>
</code></pre></div>
<p>(When <code>sizeof(swap)</code> is larger than biggest possible atomic write.)</p>
<h3 id="heap-props-layout">Heap (Props) Layout</h3>
<p>Each Assembly Hook contains a pointer to the heap stub (seen above) and a pointer to the heap.</p>
<p>The heap contains all information required to perform operations on the stub.</p>
<div class="highlight"><pre><span></span><code>- StubPackedProps
    - Enabled Flag
    - IsSwapOnly
    - SwapSize
    - HookSize
- [Hook Function / Original Code]
</code></pre></div>
<p>The data in the heap contains a short `StubPackedProps`` struct, detailing the data stored over in the
stub. </p>
<p>The <code>SwapSize</code> contains the length of the 'swap' info (and also consequently, offset of <code>HookCode</code>).<br />
The <code>HookSize</code> contains the length of the 'hook' instructions (and consequently, offset of <code>OriginalCode</code>).  </p>
<p>If the <code>IsSwapOnly</code> flag is set, then this data is to be atomically overwritten.</p>
<h3 id="the-enable-disable-process">The 'Enable' / 'Disable' Process</h3>
<div class="admonition info">
<p class="admonition-title">When transitioning between Enabled/Disabled state, we place a temporary branch at <code>entry</code>, this allows us to manipulate the remaining code safely.</p>
</div>
<div class="admonition info">
<p class="admonition-title">Using ARM64 <a href="../assembly-hooks/overview/">Assembly Hook</a> as an example.</p>
</div>
<p>We start the 'disable' process with a temporary branch:</p>
<div class="highlight"><pre><span></span><code><span class="nl">entry:</span><span class="w"> </span><span class="c1">; Currently Applied (Hook)</span>
<span class="w">    </span><span class="nf">b</span><span class="w"> </span><span class="no">original</span><span class="w"> </span><span class="c1">; Temp branch to original</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x2</span>
<span class="w">    </span><span class="nf">b</span><span class="w"> </span><span class="no">back_to_code</span>

<span class="nl">hook:</span><span class="w"> </span><span class="c1">; Backup (Hook)</span>
<span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x2</span>
<span class="w">    </span><span class="nf">b</span><span class="w"> </span><span class="no">back_to_code</span>

<span class="nl">original:</span><span class="w"> </span><span class="c1">; Backup (Original)</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span>
<span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x2</span>
<span class="w">    </span><span class="nf">b</span><span class="w"> </span><span class="no">back_to_code</span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Don't forget to clear instruction cache on non-x86 architectures which need it.</p>
</div>
<p>This ensures we can safely overwrite the remaining code...</p>
<p>Then we overwrite <code>entry</code> code with <code>hook</code> code, except the branch:</p>
<div class="highlight"><pre><span></span><code><span class="nl">entry:</span><span class="w"> </span><span class="c1">; Currently Applied (Hook)</span>
<span class="w">    </span><span class="nf">b</span><span class="w"> </span><span class="no">original</span><span class="w">     </span><span class="c1">; Branch to original</span>
<span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x2</span><span class="w">     </span><span class="c1">; overwritten with &#39;original&#39; code.</span>
<span class="w">    </span><span class="nf">b</span><span class="w"> </span><span class="no">back_to_code</span><span class="w"> </span><span class="c1">; overwritten with &#39;original&#39; code.</span>

<span class="nl">hook:</span><span class="w"> </span><span class="c1">; Backup (Hook)</span>
<span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x2</span>
<span class="w">    </span><span class="nf">b</span><span class="w"> </span><span class="no">back_to_code</span>

<span class="nl">original:</span><span class="w"> </span><span class="c1">; Backup (Original)</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span>
<span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x2</span>
<span class="w">    </span><span class="nf">b</span><span class="w"> </span><span class="no">back_to_code</span>
</code></pre></div>
<p>And lastly, overwrite the branch. </p>
<p>To do this, read the original <code>sizeof(nint)</code> bytes at <code>entry</code>, replace branch bytes with original bytes 
and do an atomic write. This way, the remaining instruction is safely replaced.</p>
<div class="highlight"><pre><span></span><code><span class="nl">entry:</span><span class="w"> </span><span class="c1">; Currently Applied (Hook)</span>
<span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span><span class="w">     </span><span class="c1">; &#39;original&#39; code.</span>
<span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x2</span><span class="w">     </span><span class="c1">; &#39;original&#39; code.</span>
<span class="w">    </span><span class="nf">b</span><span class="w"> </span><span class="no">back_to_code</span><span class="w"> </span><span class="c1">; &#39;original&#39; code.</span>

<span class="nl">original:</span><span class="w"> </span><span class="c1">; Backup (Original)</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span>
<span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x2</span>
<span class="w">    </span><span class="nf">b</span><span class="w"> </span><span class="no">back_to_code</span>

<span class="nl">hook:</span><span class="w"> </span><span class="c1">; Backup (Hook)</span>
<span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x2</span>
<span class="w">    </span><span class="nf">b</span><span class="w"> </span><span class="no">back_to_code</span>
</code></pre></div>
<p>This way we achieve zero overhead CPU-wise, at expense of some memory.</p>
<h3 id="limits">Limits</h3>
<p>Stub info is packed by default to save on memory space. By default, the following limits apply:</p>
<table>
<thead>
<tr>
<th>Property</th>
<th>4 Byte Instruction (e.g. ARM64)</th>
<th>Other (e.g. x86)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Max Orig Code Length</td>
<td>128KiB</td>
<td>32KiB</td>
</tr>
<tr>
<td>Max Hook Code Length</td>
<td>128KiB</td>
<td>32KiB</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">These limits may increase in the future if additional required functionality warrants extending metadata length.</p>
</div>
<h2 id="thread-safety-on-x86">Thread Safety on x86</h2>
<div class="admonition note">
<p class="admonition-title">Thread safety is <strong><em>'theoretically'</em></strong> not guaranteed for every possible x86 processor, however is satisfied for all modern CPUs.</p>
</div>
<div class="admonition tip">
<p class="admonition-title">The information below is x86 specific but applies to all architectures with a non-fixed instruction size. Architectures with fixed instruction sizes (e.g. ARM) are thread safe in this library by default.</p>
</div>
<h3 id="the-theory">The Theory</h3>
<blockquote>
<p>If the <code>jmp</code> instruction emplaced when <a href="../assembly-hooks/overview/#switching-state">switching state</a> overwrites what originally
  were multiple instructions, it is <em>theoretically</em> possible that the placing the <code>jmp</code> will make the
  instruction about to be executed invalid.</p>
</blockquote>
<p>For example if the previous instruction sequence was:</p>
<div class="highlight"><pre><span></span><code><span class="err">0</span><span class="nl">x0:</span><span class="w"> </span><span class="nf">push</span><span class="w"> </span><span class="no">ebp</span>
<span class="err">0</span><span class="nl">x1:</span><span class="w"> </span><span class="nf">mov</span><span class="w"> </span><span class="no">ebp</span><span class="p">,</span><span class="w"> </span><span class="no">esp</span><span class="w"> </span><span class="c1">; 2 bytes</span>
</code></pre></div>
<p>And inserting a jmp produces:</p>
<div class="highlight"><pre><span></span><code><span class="err">0</span><span class="nl">x0:</span><span class="w"> </span><span class="nf">jmp</span><span class="w"> </span><span class="no">disabled</span><span class="w"> </span><span class="c1">; 2 bytes</span>
</code></pre></div>
<p>It's possible that the CPU's Instruction Pointer was at <code>0x1`` at the time of the overwrite, making the</code>mov ebp, esp` instruction invalid.</p>
<h3 id="what-happens-in-practice">What Happens in Practice</h3>
<p>In practice, modern x86 CPUs (1990 onwards) from Intel, AMD and VIA prefetch instruction in batches 
of 16 bytes. We place our stubs generated by the various hooks on 16-byte boundaries for this 
(and optimisation) reasons.</p>
<p>So, by the time we change the code, the CPU has already prefetched the instructions we are atomically 
overwriting.</p>
<p>In other words, it is simply not possible to perfectly time a write such that a thread at <code>0x1</code> 
(<code>mov ebp, esp</code>) would read an invalid instruction, as that instruction was prefetched and is being 
executed from local thread cache.</p>
<h3 id="what-is-safe">What is Safe</h3>
<p>Here is a thread safety table for x86, taking the above into account:</p>
<table>
<thead>
<tr>
<th>Safe?</th>
<th>Hook</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>✅</td>
<td>Function</td>
<td>Functions start on multiples of 16 on pretty much all compilers, per Intel Optimisation Guide.</td>
</tr>
<tr>
<td>✅</td>
<td>Branch</td>
<td>Stubs are 16 aligned.</td>
</tr>
<tr>
<td>✅</td>
<td>Assembly</td>
<td>Stubs are 16 aligned.</td>
</tr>
<tr>
<td>✅</td>
<td>VTable</td>
<td>VTable entries are <code>usize</code> aligned, and don't cross cache boundaries.</td>
</tr>
</tbody>
</table>
<h2 id="hook-length-mismatch-problem">Hook Length Mismatch Problem</h2>
<div class="admonition info">
<p class="admonition-title">When a hook is already present, and you wish to stack that hook over the existing hook, certain problems might arise.</p>
</div>
<h3 id="when-your-hook-is-shorter-than-original">When your hook is shorter than original.</h3>
<div class="admonition tip">
<p class="admonition-title">This is notably an issue when a hook entry composes of more than 1 instruction; i.e. on RISC architectures.</p>
</div>
<div class="admonition info">
<p class="admonition-title">There is a potential register allocation caveat in this scenario.</p>
</div>
<p>Pretend you have the following ARM64 function:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:2"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">ARM64</label><label for="__tabbed_1_2">C</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="nf">ADD</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="mi">#5</span>
<span class="nf">ADD</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="mi">#10</span>
<span class="nf">ADD</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="no">x2</span>
<span class="nf">ADD</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x0</span>
<span class="nf">RET</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="nf">x1</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="no">x1</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="mi">5</span><span class="c1">;</span>
<span class="nf">x2</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="no">x2</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="mi">10</span><span class="c1">;</span>
<span class="nf">int</span><span class="w"> </span><span class="no">x0</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="no">x1</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="no">x2</span><span class="c1">;</span>
<span class="nf">x0</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="no">x0</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="no">x0</span><span class="c1">;</span>
<span class="nf">return</span><span class="w"> </span><span class="no">x0</span><span class="c1">;</span>
</code></pre></div>
</div>
</div>
</div>
<p>And then, a large hook using an <a href="../../arch/operations/#jumpabsolute">absolute jump</a> with register is applied:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Original instructions here replaced</span>
<span class="nf">MOVZ</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">A</span>
<span class="nf">MOVK</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">B</span><span class="p">,</span><span class="w"> </span><span class="no">LSL</span><span class="w"> </span><span class="mi">#16</span>
<span class="nf">MOVK</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">C</span><span class="p">,</span><span class="w"> </span><span class="no">LSL</span><span class="w"> </span><span class="mi">#32</span>
<span class="nf">MOVK</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">D</span><span class="p">,</span><span class="w"> </span><span class="no">LSL</span><span class="w"> </span><span class="mi">#48</span>
<span class="nf">B</span><span class="w"> </span><span class="no">x0</span>
<span class="c1"># &lt;= branch returns here</span>
</code></pre></div>
<p>If you then try to apply a smaller hook after applying the large hook, you might run into the following situation:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># The 3 instructions here are an absolute jump using pointer.</span>
<span class="nf">adrp</span><span class="w"> </span><span class="no">x9</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w">        </span>
<span class="no">ldr</span><span class="w"> </span><span class="no">x9</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x9</span><span class="p">,</span><span class="w"> </span><span class="mi">0x200</span><span class="p">]</span><span class="w"> </span>
<span class="no">br</span><span class="w"> </span><span class="no">x9</span>
<span class="c1"># Call to original function returns here, back to then branch to previous hook</span>
<span class="nf">MOVK</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">D</span><span class="p">,</span><span class="w"> </span><span class="no">LSL</span><span class="w"> </span><span class="mi">#48</span>
<span class="nf">B</span><span class="w"> </span><span class="no">x0</span>
</code></pre></div>
<p>This is problematic, with respect to register allocation. 
Absolute jumps on some RISC platforms like ARM will always require the use of a scratch register. </p>
<p>But there is a risk the scratch register used is the same register (<code>x0</code>) as the register used by the
previous hook as the scratch register. In which case, the jump target becomes invalid.</p>
<h4 id="resolution-strategy">Resolution Strategy</h4>
<ul>
<li>Prefer absolute jumps without scratch registers (if possible).  </li>
<li>Detect <code>mov</code> + <code>branch</code> combinations for each target architecture.<ul>
<li>And <em>extend</em> the function's stolen bytes to cover the entirety.</li>
<li>This avoids the scratch register duplication issue, as original hook code will branch to its own
code before we end up using the same scratch register.</li>
</ul>
</li>
</ul>
<h3 id="when-your-hook-is-longer-than-original">When your hook is longer than original.</h3>
<div class="admonition note">
<p class="admonition-title">Only applies to architectures with variable length instructions. (x86)</p>
</div>
<div class="admonition info">
<p class="admonition-title">Some hooking libraries don't clean up remaining stolen bytes after installing a hook.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Very notably Steam does this for rendering (overlay) and input (controller support).</p>
</div>
<p>Consider the original function having the following instructions:</p>
<div class="highlight"><pre><span></span><code>48 8B C4      mov rax, rsp
48 89 58 08   mov [rax + 08], rbx
</code></pre></div>
<p>After Steam hooks, it will leave the function like this</p>
<div class="highlight"><pre><span></span><code>E9 XX XX XX XX    jmp &#39;somewhere&#39;
58 08             &lt;invalid instruction. leftover from state before&gt;
</code></pre></div>
<p>If you're not able to install a relative hook, e.g. need to use an absolute jump</p>
<div class="highlight"><pre><span></span><code>FF 25 XX XX XX XX    jmp [&#39;addr&#39;]
</code></pre></div>
<p>The invalid instructions will now become part of the 'stolen' bytes, <a href="../function-hooks/overview/#when-activated">when you call the original</a>; 
and invalid instructions may be executed.</p>
<h4 id="resolution-strategy_1">Resolution Strategy</h4>
<p>This library must do the following:  </p>
<ul>
<li>Prefer shorter hooks (<code>relative jump</code> over <code>absolute jump</code>) when possible.  </li>
<li>Leave nop(s) after placing any branches, to avoid leaving invalid instructions.<ul>
<li>Don't contribute to the problem.   </li>
</ul>
</li>
</ul>
<p>There unfortunately isn't much we can do to detect invalid instructions generated by other hooking libraries
reliably, best we can do is try to avoid it by using shorter hooks. Thankfully this is not a common issue
given most people use the 'popular' libraries.</p>
<h2 id="fallback-strategies">Fallback Strategies</h2>
<h3 id="return-address-patching">Return Address Patching</h3>
<div class="admonition warning">
<p class="admonition-title">This feature will not be ported over from legacy <code>Reloaded.Hooks</code>, until an edge case is found that requires this.</p>
</div>
<div class="admonition note">
<p class="admonition-title">This section explains how Reloaded handles an edge case within an already super rare case.</p>
</div>
<div class="admonition note">
<p class="admonition-title">This topic is a bit more complex, so we will use x86 as example here.</p>
</div>
<p>For any of this to be necessary, the following conditions must be true:  </p>
<ul>
<li>An existing <a href="../../arch/operations/#jumprelative">relative jump</a> hook exists.  </li>
<li>Reloaded can't find free memory within <a href="../../arch/operations/#jumprelative">relative jump</a> range.  </li>
<li>The existing hook was somehow able to find free memory in this range, but we can't...  (&lt;= main reason this is improbable!!)</li>
<li><a href="#free-space-from-function-alignment">Free Space from Function Alignment Strategy</a> fails.  </li>
<li>The instructions at beginning of the hooked function happened to just perfectly align such that our hook
  jump is longer than the existing one.  </li>
</ul>
<p>The low probability of this happening, at least on Windows and/or Linux is rather insane. It cannot
be estimated, but if I were to have a guess, maybe 1 in 1 billion. You'd be more likely to die 
from a shark attack.</p>
<hr />
<p>In any case, when this happens, Reloaded performs <em>return address patching</em>.  </p>
<p>Suppose a foreign hooking library hooks a function with the following prologue:</p>
<div class="highlight"><pre><span></span><code><span class="err">55</span><span class="w">        </span><span class="nf">push</span><span class="w"> </span><span class="no">ebp</span>
<span class="err">89</span><span class="w"> </span><span class="nf">e5</span><span class="w">     </span><span class="no">mov</span><span class="w"> </span><span class="no">ebp</span><span class="p">,</span><span class="w"> </span><span class="no">esp</span>
<span class="err">00</span><span class="w"> </span><span class="err">00</span><span class="w">     </span><span class="nf">add</span><span class="w"> </span><span class="p">[</span><span class="no">eax</span><span class="p">],</span><span class="w"> </span><span class="no">al</span>
<span class="err">83</span><span class="w"> </span><span class="nf">ec</span><span class="w"> </span><span class="mi">20</span><span class="w">  </span><span class="no">sub</span><span class="w"> </span><span class="no">esp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="w"> </span>
<span class="no">...</span>
</code></pre></div>
<p>After hooking, this code would look like:</p>
<div class="highlight"><pre><span></span><code><span class="nf">E9</span><span class="w"> </span><span class="no">XX</span><span class="w"> </span><span class="no">XX</span><span class="w"> </span><span class="no">XX</span><span class="w"> </span><span class="no">XX</span><span class="w">  </span><span class="no">jmp</span><span class="w"> </span><span class="err">&#39;</span><span class="no">somewhere</span><span class="err">&#39;</span>
<span class="err">&lt;=</span><span class="w"> </span><span class="nf">existing</span><span class="w"> </span><span class="no">hook</span><span class="w"> </span><span class="no">jumps</span><span class="w"> </span><span class="no">back</span><span class="w"> </span><span class="no">here</span><span class="w"> </span><span class="no">when</span><span class="w"> </span><span class="no">calling</span><span class="w"> </span><span class="no">original</span><span class="w"> </span><span class="p">(</span><span class="no">this</span><span class="p">)</span><span class="w"> </span><span class="no">function</span>
<span class="err">83</span><span class="w"> </span><span class="nf">ec</span><span class="w"> </span><span class="mi">20</span><span class="w">        </span><span class="no">sub</span><span class="w"> </span><span class="no">esp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="w"> </span>
<span class="no">...</span>
</code></pre></div>
<p>When the prologue is set up 'just right', such that the existing instrucions divide perfectly
into 5 bytes, and we need to insert a 6 byte absolute jmp <code>FF 25</code>, Reloaded must patch the return address.</p>
<p>Reloaded has a built in patcher for this super rare scenario, which detects and attempts to patch return
addresses of the following patterns:</p>
<div class="highlight"><pre><span></span><code>Where nop* represents 0 or more nops.

1. Relative immediate jumps.       

    nop*
    jmp 0x123456
    nop*

2. Push + Return

    nop*
    push 0x612403
    ret
    nop*

3. RIP Relative Addressing (X64)

    nop*
    JMP [RIP+0]
    nop*
</code></pre></div>
<p>This patching mechanism is rather complicated, relies on disassembling code at runtime and thus won't be explained here.</p>
<div class="admonition danger">
<p class="admonition-title">Different hooking libraries use different logic for storing callbacks. In some cases alignment of code (or rather lack thereof) can also make this operation unreliable, since we rely on disassembling the code at runtime to find jumps back to end of hook. <strong><em>The success rate of this operation is NOT 100%</em></strong></p>
</div>
<h2 id="requirements-for-external-libraries-to-interoperate">Requirements for External Libraries to Interoperate</h2>
<div class="admonition note">
<p class="admonition-title">While I haven't studied the source code of other hooking libraries before, I've had no issues in the past with the common <a href="https://github.com/microsoft/Detours">Detours</a> and <a href="https://github.com/TsudaKageyu/minhook.git">minhook</a> libraries that are commonly used</p>
</div>
<h3 id="hooking-over-reloaded-hooks">Hooking Over Reloaded Hooks</h3>
<div class="admonition info">
<p class="admonition-title">Libraries which can safely interoperate (stack hooks ontop) of Reloaded Hooks Hooks' must satisfy the following.</p>
</div>
<ul>
<li>
<p>Must be able to patch (re-adjust) <a href="../../arch/operations/#jumprelative">relative jumps</a>.  </p>
<ul>
<li>In some cases when assembling call to original function, relative jump target may be out of range,
  compatible hooking software must handle this edge case.</li>
</ul>
</li>
<li>
<p>Must be able to automatically determine number of bytes to steal from original function.  </p>
<ul>
<li>This makes it possible to interoperate with the rare times we do a <a href="../../arch/operations/#jumpabsolute">absolute jump</a> when 
  it may not be possible to do a relative jump (i.e.) as we cannot allocate memory in close
  enough proximity. </li>
</ul>
</li>
</ul>
<h3 id="reloaded-hooks-hooking-over-existing-hooks">Reloaded Hooks hooking over Existing Hooks</h3>
<div class="admonition info">
<p class="admonition-title">See: <a href="../../arch/overview/#code-relocation">Code Relocation</a></p>
</div>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
      
      
    
    <a href="https://github.com/Reloaded-Project" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.instant"], "search": "../../../assets/javascripts/workers/search.e5c33ebb.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.51d95adb.min.js"></script>
      
    
  </body>
</html>