
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://github.com/Reloaded-Project/Reloaded.Hooks-rs/dev/design/assembly-hooks/overview/">
      
      
        <link rel="prev" href="../../function-hooks/hooking-strategy-arm64/">
      
      
        <link rel="next" href="../../branch-hooks/overview/">
      
      <link rel="icon" href="../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.0.6">
    
    
      
        <title>Assembly Hooks - Reloaded Hooks NexGen</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.558e4712.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.2505c338.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../Reloaded/Stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="reloaded3-slate" data-md-color-primary="" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#assembly-hooks" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../.." title="Reloaded Hooks NexGen" class="md-header__button md-logo" aria-label="Reloaded Hooks NexGen" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Reloaded Hooks NexGen
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Assembly Hooks
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/Reloaded-Project/Reloaded.Hooks-rs" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    Reloaded-Project/Reloaded.Hooks-rs
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="Reloaded Hooks NexGen" class="md-nav__button md-logo" aria-label="Reloaded Hooks NexGen" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Reloaded Hooks NexGen
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/Reloaded-Project/Reloaded.Hooks-rs" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    Reloaded-Project/Reloaded.Hooks-rs
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      
      
        <label class="md-nav__link" for="__nav_2" tabindex="0" aria-expanded="true">
          Library Internals
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Library Internals" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Library Internals
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " data-md-toggle="__nav_2_1" type="checkbox" id="__nav_2_1" checked>
      
      
      
        <label class="md-nav__link" for="__nav_2_1" tabindex="0" aria-expanded="true">
          Design Docs
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Design Docs" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_1">
          <span class="md-nav__icon md-icon"></span>
          Design Docs
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../common/" class="md-nav__link">
        Common Notes
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../wrappers/" class="md-nav__link">
        Wrapper Generation
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " data-md-toggle="__nav_2_1_3" type="checkbox" id="__nav_2_1_3" >
      
      
      
        <label class="md-nav__link" for="__nav_2_1_3" tabindex="0" aria-expanded="false">
          Function Hooks
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Function Hooks" data-md-level="3">
        <label class="md-nav__title" for="__nav_2_1_3">
          <span class="md-nav__icon md-icon"></span>
          Function Hooks
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../function-hooks/overview/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " data-md-toggle="__nav_2_1_3_2" type="checkbox" id="__nav_2_1_3_2" >
      
      
      
        <label class="md-nav__link" for="__nav_2_1_3_2" tabindex="0" aria-expanded="false">
          Hooking Strategy
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Hooking Strategy" data-md-level="4">
        <label class="md-nav__title" for="__nav_2_1_3_2">
          <span class="md-nav__icon md-icon"></span>
          Hooking Strategy
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../function-hooks/hooking-strategy/" class="md-nav__link">
        General
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../function-hooks/hooking-strategy-x86/" class="md-nav__link">
        x86
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../function-hooks/hooking-strategy-arm64/" class="md-nav__link">
        ARM64
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Assembly Hooks
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Assembly Hooks
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#high-level-diagram" class="md-nav__link">
    High Level Diagram
  </a>
  
    <nav class="md-nav" aria-label="High Level Diagram">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#key" class="md-nav__link">
    Key
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#when-activated" class="md-nav__link">
    When Activated
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#when-deactivated" class="md-nav__link">
    When Deactivated
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#usage-notes" class="md-nav__link">
    Usage Notes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hook-lengths" class="md-nav__link">
    Hook Lengths
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#thread-safety-memory-layout-state-switching" class="md-nav__link">
    Thread Safety, Memory Layout &amp; State Switching
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#legacy-compatibility-considerations" class="md-nav__link">
    Legacy Compatibility Considerations
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#limits" class="md-nav__link">
    Limits
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../branch-hooks/overview/" class="md-nav__link">
        Branch Hooks
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vtable-hooks/overview/" class="md-nav__link">
        VTable Hooks
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " data-md-toggle="__nav_2_2" type="checkbox" id="__nav_2_2" >
      
      
      
        <label class="md-nav__link" for="__nav_2_2" tabindex="0" aria-expanded="false">
          Architectures
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Architectures" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_2">
          <span class="md-nav__icon md-icon"></span>
          Architectures
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../arch/overview/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../arch/operations/" class="md-nav__link">
        Operations
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../arch/operations-impl/" class="md-nav__link">
        Operations (Implemented)
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " data-md-toggle="__nav_2_2_4" type="checkbox" id="__nav_2_2_4" >
      
      
      
        <label class="md-nav__link" for="__nav_2_2_4" tabindex="0" aria-expanded="false">
          x86
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="x86" data-md-level="3">
        <label class="md-nav__title" for="__nav_2_2_4">
          <span class="md-nav__icon md-icon"></span>
          x86
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../arch/x86/x86/" class="md-nav__link">
        Overview (x86)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../arch/x86/x86_64/" class="md-nav__link">
        Overview (x86_64)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../arch/x86/code_relocation/" class="md-nav__link">
        Code Relocation
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " data-md-toggle="__nav_2_2_5" type="checkbox" id="__nav_2_2_5" >
      
      
      
        <label class="md-nav__link" for="__nav_2_2_5" tabindex="0" aria-expanded="false">
          arm64
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="arm64" data-md-level="3">
        <label class="md-nav__title" for="__nav_2_2_5">
          <span class="md-nav__icon md-icon"></span>
          arm64
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../arch/arm64/aarch64/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../arch/arm64/code_relocation/" class="md-nav__link">
        Code Relocation
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../platform/overview/" class="md-nav__link">
        Platform Support
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../contributing/" class="md-nav__link">
        Contributing
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../Reloaded/Pages/license/" class="md-nav__link">
        License
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../Reloaded/Pages/contributing/" class="md-nav__link">
        How to Document
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#high-level-diagram" class="md-nav__link">
    High Level Diagram
  </a>
  
    <nav class="md-nav" aria-label="High Level Diagram">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#key" class="md-nav__link">
    Key
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#when-activated" class="md-nav__link">
    When Activated
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#when-deactivated" class="md-nav__link">
    When Deactivated
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#usage-notes" class="md-nav__link">
    Usage Notes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hook-lengths" class="md-nav__link">
    Hook Lengths
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#thread-safety-memory-layout-state-switching" class="md-nav__link">
    Thread Safety, Memory Layout &amp; State Switching
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#legacy-compatibility-considerations" class="md-nav__link">
    Legacy Compatibility Considerations
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#limits" class="md-nav__link">
    Limits
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  



<h1 id="assembly-hooks">Assembly Hooks</h1>
<div class="admonition info">
<p class="admonition-title">Replacing arbitrary assembly sequences (a.k.a. 'mid function hooks').</p>
</div>
<div class="admonition info">
<p class="admonition-title">This hook is used to make small changes to existing logic, for example injecting custom logic for existing conditional branches (<code>if</code> statements).</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Limited effectiveness if <a href="../../../arch/overview/#code-relocation">Code Relocation</a> is not available.</p>
</div>
<div class="admonition note">
<p class="admonition-title">I'm not a security person/researcher. I just make full stack game modding tools, mods and libraries. Naming in these design docs might be unconventional.</p>
</div>
<p>This hook works by injecting a <code>jmp</code> instruction inside the middle of an arbitrary assembly sequence
to custom code. The person using this hook must be very careful not to break the program 
(corrupt stack, used registers, etc.).</p>
<h2 id="high-level-diagram">High Level Diagram</h2>
<h3 id="key">Key</h3>
<ul>
<li><code>Original Code</code>: Middle of an arbitrary sequence of assembly instructions where a <code>branch</code> to custom code is placed.  </li>
<li><code>Hook Function</code>: Contains user code, including original code (depending on user preference).  <ul>
<li>When the hook is deactivated, this contains the original code only.</li>
</ul>
</li>
<li><code>Original Stub</code>: Original code (used when hook disabled).  </li>
</ul>
<h3 id="when-activated">When Activated</h3>
<pre class="mermaid"><code>flowchart TD
    O[Original Code]
    HK[Hook Function]

    O -- jump --&gt; HK
    HK -- jump back --&gt; O</code></pre>
<p>When the hook is activated, a <code>branch</code> is placed in the middle of the original assembly instruction
sequence to your hook code.</p>
<p>Your code (and/or original code) is then executed, then it branches back to original code.</p>
<h3 id="when-deactivated">When Deactivated</h3>
<pre class="mermaid"><code>flowchart TD
    O[Original Function]
    HK["Hook Function &amp;lt;Overwritten with Original Code&amp;gt;"]

    O -- jump --&gt; HK
    HK -- jump back --&gt; O</code></pre>
<p>When the hook is deactivated, the 'Hook Function' is overwritten in-place with original instructions 
and a jump back to your code.</p>
<h2 id="usage-notes">Usage Notes</h2>
<div class="admonition note">
<p class="admonition-title">Assembly Hooks should allow both Position Independent Code and Position Relative Code</p>
</div>
<p>With that in mind, the following APIs should be possible: </p>
<div class="highlight"><pre><span></span><code><span class="sd">/// Creates an Assembly Hook given existing position independent assembly code,</span>
<span class="sd">/// and address which to hook.</span>
<span class="sd">/// # Arguments</span>
<span class="sd">/// * `hook_address` - The address of the function or mid-function to hook.</span>
<span class="sd">/// * `asm_code` - The assembly code to execute, precompiled.</span>
<span class="k">fn</span> <span class="nf">from_pos_independent_code_and_function_address</span><span class="p">(</span><span class="n">hook_address</span>: <span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">asm_code</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">]);</span>

<span class="sd">/// Creates an Assembly Hook given existing position assembly code,</span>
<span class="sd">/// and address which to hook.</span>
<span class="sd">/// </span>
<span class="sd">/// # Arguments</span>
<span class="sd">/// * `hook_address` - The address of the function or mid-function to hook.</span>
<span class="sd">/// * `asm_code` - The assembly code to execute, precompiled.</span>
<span class="sd">/// * `code_address` - The original address of asm_code. </span>
<span class="sd">/// </span>
<span class="sd">/// # Remarks</span>
<span class="sd">/// Code in `asm_code` will be relocated to new target address. </span>
<span class="k">fn</span> <span class="nf">from_code_and_function_address</span><span class="p">(</span><span class="n">hook_address</span>: <span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">asm_code</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">],</span><span class="w"> </span><span class="n">code_address</span>: <span class="kt">usize</span><span class="p">);</span>

<span class="sd">/// Creates an Assembly Hook given existing position assembly code,</span>
<span class="sd">/// and address which to hook.</span>
<span class="sd">/// </span>
<span class="sd">/// # Arguments</span>
<span class="sd">/// * `hook_address` - The address of the function or mid-function to hook.</span>
<span class="sd">/// * `asm_isns` - The assembly instructions to place at this address.</span>
<span class="sd">/// </span>
<span class="sd">/// # Remarks</span>
<span class="sd">/// Code in `asm_code` will be relocated to new target address. </span>
<span class="k">fn</span> <span class="nf">from_instructions_and_function_address</span><span class="p">(</span><span class="n">hook_address</span>: <span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">asm_isns</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">Instructions</span><span class="p">]);</span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Using overloads for clarity, in library all options should live in a struct.</p>
</div>
<p>Code using <code>from_code_and_function_address</code> is to be preferred for usage, as users will be able to use
relative branches for improved efficiency. (If they are out of range, hooking library will rewrite them)</p>
<p>For pure assembly code, users are expected to compile code externally using something like <code>FASM</code>, 
put the code in their program/mod (as byte array) and pass that directly as <code>asm_code</code>.</p>
<p>For people who want to call their own program/mod(s) from assembly, there will be a wrapper API around
<code>Jit&lt;TRegister&gt;</code> and its various <a href="../../../arch/operations/">Operations</a>. This API will be cross-architecture and
should contain all the necessary operations required for setting up stack/registers and calling user code.</p>
<p>Programmers are also expected to provide 'max allowed hook length' with each call.</p>
<h2 id="hook-lengths">Hook Lengths</h2>
<div class="admonition note">
<p class="admonition-title">The expected hook lengths for each architecture</p>
</div>
<p>When using the library, the library will use the most optimal possible <code>jmp</code> instruction to get to the user hook.  </p>
<p>When calling one of the functions to create an assembly hook, the end user should specify their max permissible assembly hook length.  </p>
<p>If a hook cannot be satisfied within that constraint, then library will throw an error.</p>
<p>The following table below shows common hook lengths, for:  </p>
<ul>
<li><code>Relative Jump</code> (best case)  </li>
<li><a href="../../../platform/overview/#recommended-targeted-memory-allocation">Targeted Memory Allocation (TMA)</a> (expected best case) when above <code>Relative Jump</code> range.  </li>
<li>Worst case scenario.  </li>
</ul>
<table>
<thead>
<tr>
<th>Architecture</th>
<th>Relative</th>
<th>TMA</th>
<th>Worst Case</th>
</tr>
</thead>
<tbody>
<tr>
<td>x86<sup>[1]</sup></td>
<td>5 bytes (+- 2GiB)</td>
<td>5 bytes</td>
<td>5 bytes</td>
</tr>
<tr>
<td>x86_64</td>
<td>5 bytes (+- 2GiB)</td>
<td>6 bytes<sup>[2]</sup></td>
<td>13 bytes<sup>[3]</sup></td>
</tr>
<tr>
<td>x86_64 (macOS)</td>
<td>5 bytes (+- 2GiB)</td>
<td>13 bytes<sup>[4]</sup></td>
<td>13 bytes<sup>[3]</sup></td>
</tr>
<tr>
<td>ARM64</td>
<td>4 bytes (+- 128MiB)</td>
<td>12 bytes<sup>[6]</sup></td>
<td>20 bytes<sup>[5]</sup></td>
</tr>
<tr>
<td>ARM64 (macOS)</td>
<td>4 bytes (+- 128MiB)</td>
<td>12 bytes<sup>[6]</sup></td>
<td>20 bytes<sup>[5]</sup></td>
</tr>
</tbody>
</table>
<p><sup>[1]</sup>: x86 can reach any address from any address with relative branch due to integer overflow/wraparound.<br />
<sup>[2]</sup>: <a href="../../../arch/operations/#jumpabsoluteindirect"><code>jmp [&lt;Address&gt;]</code>, with &lt;Address&gt; at &lt; 2GiB</a>.<br />
<sup>[3]</sup>: <a href="../../../arch/operations/#jumpabsolute"><code>mov &lt;reg&gt;, address</code> + <code>call &lt;reg&gt;</code></a>. +1 if using an extended reg.<br />
<sup>[4]</sup>: macOS restricts access to <code>&lt; 2GiB</code> memory locations, so absolute jump must be used. +1 if using an extended reg.<br />
<sup>[5]</sup>: <a href="../../../arch/operations/#jumpabsolute">MOVZ + MOVK + LDR + BR</a>.<br />
<sup>[6]</sup>: <a href="../../../arch/operations/#jumprelative">ADRP + ADD + BR</a>.  </p>
<h2 id="thread-safety-memory-layout-state-switching">Thread Safety, Memory Layout &amp; State Switching</h2>
<div class="admonition info">
<p class="admonition-title">Common: <a href="../../common/#hook-memory-layouts--thread-safety">Thread Safety &amp; Memory Layout</a></p>
</div>
<h2 id="legacy-compatibility-considerations">Legacy Compatibility Considerations</h2>
<div class="admonition note">
<p class="admonition-title">As <code>reloaded-hooks-rs</code> intends to replace <code>Reloaded.Hooks</code> is must provide certain functionality for backwards compatibility.</p>
</div>
<div class="admonition info">
<p class="admonition-title">Once <code>reloaded-hooks-rs</code> releases, the legacy <code>Reloaded.Hooks</code> will be a wrapper around it.</p>
</div>
<p>This means a few functionalities must be supported here:</p>
<ul>
<li>
<p>Setting arbitrary 'Hook Length'.</p>
<ul>
<li>This is the amount of bytes stolen from the original code to be included as 'original code' in hook.</li>
<li>On x86 <code>Reloaded.Hooks</code> users create an ASM Hook (with default <code>PreferRelativeJump == false</code> and <code>HookLength == -1</code>) the wrapper for legacy API must set <code>'Hook Length' == 7</code> to emulate absolute jump size.</li>
<li>Respecting <code>MaxOpcodeSize</code> from original API should be sufficient.</li>
</ul>
</li>
<li>
<p>Supporting Assembly via FASM.</p>
<ul>
<li>As this is only possible in Windows (FASM can't be recompiled on other OSes as library), this feature will be getting dropped.</li>
<li>The <code>Reloaded.Hooks</code> wrapper will continue to ship FASM for backwards compatibility, however mods are expected to migrate to the new library in the future.</li>
</ul>
</li>
</ul>
<h2 id="limits">Limits</h2>
<p>Assembly hook info is packed by default to save on memory space. By default, the following limits apply:</p>
<table>
<thead>
<tr>
<th>Property</th>
<th>4 Byte Instruction (e.g. ARM64)</th>
<th>Other (e.g. x86)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Max Orig Code Length</td>
<td>128KiB</td>
<td>32KiB</td>
</tr>
<tr>
<td>Max Hook Code Length</td>
<td>128KiB</td>
<td>32KiB</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">These limits may increase in the future if additional functionality warrants extending metadata length.</p>
</div>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
      
      
    
    <a href="https://github.com/Reloaded-Project" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../../../..", "features": ["navigation.instant"], "search": "../../../../assets/javascripts/workers/search.e5c33ebb.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.51d95adb.min.js"></script>
      
    
  </body>
</html>